<div class="container-show">
  <div class="proposal-progress-container row">
    <div class="proposal-section col-6">
      <div class="proposal-box">
        <div class="titles">
          <h2><%= @proposal.title %></h2>

          <%= link_to edit_proposal_path(@proposal), class: "edit-icon" do%>
            <i class="fi fi-rs-edit"></i>
          <% end %>
        </div>
        <div class="proposal-description-details">
          <h4>Description</h4>
          <p><%= @proposal.description %></p>
          <div class="proposal-details d-flex justify-content-between">
            <div class="proposal-status">
              <h4>Status</h4>
              <p><%= @proposal.status  %></p>
            </div>
            <div class="proposal-budget">
              <h4>Budget</h4>
              <p><%=@proposal.budget %>â‚¬</p>
            </div>
            <div class="proposal-due-date">
              <h4>Due date </h4>
              <p><%=@proposal.due_date %></p>
            </div>
          </div>


        </div>
      </div>

      <% if @proposal.steps.first %>
        <% if (@proposal.steps.order('created_at asc').last.approver == current_user) && (@proposal.steps.last.status == "approved") && (@proposal.status != "approved") %>
        <div>
          <p>You are the final approver of the proposal! Please add a new approver if necessary or confirm proposal approval</p>
          <p>Approval Flow: <%= link_to @proposal.approval_flow.name, approval_flow_path(@proposal.approval_flow) %></p>
          <p> <%= link_to "Confirm final approval", proposal_approve_path(@proposal), method: "patch", class: "btn-flat-white  mt-2" %></p>
        </div>
        <% end  %>
      <% end  %>

      <% if @proposal.status == "approved"  %>
        <h1> ðŸŽ‰ The proposal is approved ðŸŽ‰ </h1>
      <%end %>
      </div>
    <div class="empty-section col-1">
    </div>
    <div class="progress-section col-4">
        <div class="progress-steps blue-box p-3">
          <h3><i class="fi fi-rs-time-past pb-3"></i> Progress:</h3>
          <div class="step-list">
            <div class="step-container"><%= @proposal.creator.first_name %> initiated on <%= @proposal.created_at.strftime("%e %b %Y") %></div>

            <% if @ordered_steps %>
              <% @ordered_steps.each_with_index do |step, i| %>

              <div class="step-container"><span class="progress-dates-color">Step <%= i + 1 %> - Approver: <%= step.approver.first_name %> - Status: <%= step.status %></span>
              <% if step.logs %>
                <% step.logs.each do |log| %>
                <p>Step changed from <span class="progress-dates-color"><%= log.original_status %> </span> to <span class="progress-dates-color"><%= log.updated_status %></span> on <%= log.created_at.strftime("%e %b %Y")  %></p>
                <% end  %>
              <% end %>
              </div>
              <%end%>
            <% end  %>
          </div>
        </div>

    </div>
    <div class="approval-flow-actions d-flex mt-3 justify-content-between align-items-center mb-3">
      <div class="approval-flow-if-created">
        <% if @proposal.approval_flow.nil? && @proposal.creator == current_user %>
          <div class="p-3">
            <%= link_to  "Create Approval Flow", new_proposal_approval_flow_path(@proposal), class: "btn-flat-white" %>
          </div>
        <% else %>
          <div class="with-created-approval justify-content-start flex-grow-1">
            <h4>Approval Flow: <%= link_to @proposal.approval_flow.name, approval_flow_path(@proposal.approval_flow), class: ""%></h4>
          </div>
        <% end %>
      </div>
      <div class="approval-flow-start p-3">
        <% if (@proposal.approval_flow) && (@proposal.approval_flow.steps.first) && (@proposal.steps.first.status == "created") && (@proposal.creator == current_user) %>
              <%= link_to "Start Approval Flow", step_start_path(@proposal.steps.first), method: "patch", class: "btn-flat-white"%>
        <% end %>
      </div>
      <div class="p-3">
        <%= link_to "Add approvers", "#", class: "btn-flat-white col-2" %>
      </div>
    </div>
  </div>

  <div class="comments row">
    <% if @action_step  %>
    <div class="actions-secction">
        <h2 class="action-header mt-3 mb-5">What do you want to do?</h2>
        <div class="buttons-approve mb-5">
          <%= link_to "Approve", step_approve_path(@action_step), method: "patch", data: { bs_toggle: "modal", bs_target:"#exampleModal" }, class: "btn-green-approve" %>

          <%= link_to "Reject", step_reject_path(@action_step), method: "patch", data: { bs_toggle: "modal", bs_target:"#exampleModal" }, class: "btn-orange-reject" %>

          <%= link_to "Change", step_request_change_path(@action_step), method: "patch", data: { bs_toggle: "modal", bs_target:"#exampleModal" }, class: "btn-yellow-change" %>
        </div>
      <% end  %>
      <% if @proposal.creator == current_user && (@proposal.steps.count {|step| step.status == "change request"} >= 1) %>
        <%= link_to "Changes done", step_new_review_path(@proposal.steps.find {|step| step.status == "change request"}), method: "patch", data: { bs_toggle: "modal", bs_target:"#exampleModal" } %>
      <% end  %>

        <%# --- modal --- %>
      <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Add comment to action:</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <% if (@proposal.approval_flow) && (@proposal.approval_flow.steps.first)  %>
                  <%= simple_form_for [@proposal, @proposal.approval_flow, @proposal.approval_flow.steps.first, @comment] do |f| %>
                        <%= f.input :content, label: "Your comment" %>
                        <%= f.submit "Post", class: "btn-btn-primary" %>
                  <%end%>
                <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <% if @proposal.steps.first  %>
    <div class="comments-section">
      <div class="add-comment-box mt-3 p-3">
        <h3>+ Add a comment</h3>
        <%= simple_form_for [@proposal, @proposal.approval_flow, @proposal.approval_flow.steps.first, @comment] do |f| %>
                <%= f.input :content, label: "Your comment" %>
                <%= f.submit "Post", class: "btn btn-flat-blue" %>
        <% end %>
      </div>
    <% end %>

        <% if @proposal.steps.first  %>
    <div class="all-coments-box mt-3 p-3">
          <h3>All Comments:</h3>
        <% end  %>

          <% if @ordered_steps %>
            <% @ordered_steps.each do |step| %>
            <% if step.comments %>
            <% step.comments.each do |comment| %>
                <div class="comment-item mb-3 p-2">
                  <h4>Posted by: <%= comment.user.first_name %> <%#= comment.user.last_name %> on <%= comment.created_at.strftime("%e %b %Y")  %></h4>
                  <p><%= comment.content %></p>
                </div>
              <% end %>
            <% end %>
            <%end%>
          <%end%>

      </div>

    </div>
  </div>
</div>
